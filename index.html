<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notes</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100%;
      width: 100%;
      background-color: #f5f5f5;
      overflow: hidden;
      position: fixed;
    }
    
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 95%;
      width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    @media (min-width: 600px) {
      .chat-container {
        max-width: 600px;
        margin: 10px auto;
        height: calc(100% - 20px);
      }
    }
    
    #messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px;
      background: white;
    }
    
    .sent {
      text-align: right;
      margin-bottom: 8px;
      color: #2196F3;
    }
    
    .received {
      text-align: left;
      margin-bottom: 8px;
      color: #333;
    }
    
    .input-area {
      padding: 8px 10px;
      background: white;
      display: flex;
      align-items: center;
      border-top: 1px solid #eee;
    }
    
    #message-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 24px;
      background: #f9f9f9;
      outline: none;
      font-size: 16px;
    }
    
    #send-button, #test-read, #test-write {
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 24px;
      padding: 10px 16px;
      margin-left: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    
    #test-area {
      display: flex;
      padding: 8px;
      background: #f5f5f5;
      border-top: 1px solid #eee;
    }
    
    #test-read, #test-write {
      background: #888;
      flex: 1;
    }
    
    #debug {
       display: none
    }
    
    /* Fix for iOS height issues */
    @supports (-webkit-touch-callout: none) {
      body, html {
        height: -webkit-fill-available;
      }
      .chat-container {
        height: -webkit-fill-available;
      }
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div id="messages"></div>
    <div class="input-area">
      <input type="text" id="message-input" placeholder="Type a message">
      <button id="send-button">Send</button>
    </div>
    <div id="test-area">
      <button id="test-write">Test Write</button>
      <button id="test-read">Test Read</button>
    </div>
  </div>
  
  <div id="debug">Debug info will appear here...</div>
  
  <!-- Load Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  
  <script>
    // Debug logging function
    function log(message) {
      const debug = document.getElementById('debug');
      const time = new Date().toLocaleTimeString();
      debug.innerHTML += `[${time}] ${message}\n`;
      debug.scrollTop = debug.scrollHeight;
      console.log(message);
    }
    
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBw-lFRPy_OIHDXneC-SHaQG0cMK6RCOeo",
      authDomain: "family-7fa14.firebaseapp.com",
      databaseURL: "https://family-7fa14-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "family-7fa14",
      storageBucket: "family-7fa14.firebasestorage.app",
      messagingSenderId: "725704438162",
      appId: "1:725704438162:web:87a7cbad460726fa49114b"
    };
    
    // Initialize Firebase
    try {
      log("Initializing Firebase...");
      const app = firebase.initializeApp(firebaseConfig);
      log("Firebase initialized successfully.");
      
      const db = firebase.database();
      log("Database reference created.");
      
      // Generate a random user ID
      const userId = "user_" + Math.floor(Math.random() * 1000000);
      log(`Using user ID: ${userId}`);
      
      // Reference to messages
      const messagesRef = db.ref("simple-messages");
      log(`Created reference to 'simple-messages' path.`);
      
      // Set up UI elements
      const messagesDiv = document.getElementById("messages");
      const messageInput = document.getElementById("message-input");
      const sendButton = document.getElementById("send-button");
      const testWriteButton = document.getElementById("test-write");
      const testReadButton = document.getElementById("test-read");
      
      // Listen for messages
      messagesRef.on("child_added", (snapshot) => {
        try {
          const message = snapshot.val();
          log(`Message received: ${JSON.stringify(message)}`);
          
          const messageElement = document.createElement("div");
          messageElement.className = message.userId === userId ? "sent" : "received";
          messageElement.textContent = `${message.text} (${new Date(message.timestamp).toLocaleTimeString()})`;
          
          messagesDiv.appendChild(messageElement);
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } catch (error) {
          log(`Error displaying message: ${error.message}`);
        }
      }, (error) => {
        log(`Error listening for messages: ${error.message}`);
      });
      
      // Send message function
      function sendMessage() {
        const text = messageInput.value.trim();
        if (!text) return;
        
        log(`Trying to send message: "${text}"`);
        
        const message = {
          text: text,
          userId: userId,
          timestamp: Date.now()
        };
        
        // Clear input
        messageInput.value = "";
        
        // Push to Firebase
        messagesRef.push(message)
          .then(() => {
            log("Message sent successfully!");
          })
          .catch((error) => {
            log(`Error sending message: ${error.message}`);
          });
      }
      
      // Test write function
      function testWrite() {
        log("Testing write permission...");
        db.ref("test-write").set({
          timestamp: Date.now(),
          test: "write"
        })
        .then(() => {
          log("Write test successful!");
        })
        .catch((error) => {
          log(`Write test failed: ${error.message}`);
        });
      }
      
      // Test read function
      function testRead() {
        log("Testing read permission...");
        db.ref(".info/connected").once("value")
          .then((snapshot) => {
            log(`Read test successful! Connected: ${snapshot.val()}`);
          })
          .catch((error) => {
            log(`Read test failed: ${error.message}`);
          });
      }
      
      // Event listeners
      sendButton.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
      testWriteButton.addEventListener("click", testWrite);
      testReadButton.addEventListener("click", testRead);
      
      // Initial tests
      testRead();
      
    } catch (error) {
      log(`Error in setup: ${error.message}`);
    }
  </script>
</body>
</html>
